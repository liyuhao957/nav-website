<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航网站</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 
                Roboto, Oxygen-Sans, Ubuntu, Cantarell, 
                'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #2c3e50;
            line-height: 1.5;
            text-rendering: optimizeLegibility;
        }

        /* 确保所有文本元素使用相同的字体设置 */
        input, button, select, textarea {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }

        /* 统一不同系统下的文本渲染 */
        .link-title, .link-description, .section-title {
            font-weight: 500;  /* 使用数字而不是 'bold' */
            letter-spacing: -0.01em;  /* 细微调整字母间距 */
        }

        /* 确保按钮在不同系统下的一致性 */
        button {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            margin: 0;
        }

        /* 主要内容区域布局 */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin: 0;
            padding: 0 0 0 30px;
        }

        /* 搜索区域样式 */
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            min-width: 0;
        }

        .search-options {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-group {
            display: flex;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .radio-label:hover {
            background: #e9ecef;
        }

        .search-button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-button:hover {
            background: #0056b3;
        }

        /* 链接列表区域样式 */
        .links-section {
            background: white;
            border-radius: 0;
            box-shadow: none;
            padding: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 2px solid #f0f0f0;
            margin: 0;
            position: sticky;
            top: 84px;  /* 搜索框的高度 + padding */
            z-index: 99;
        }

        .section-header .section-title {
            font-size: 28px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        /* 分类筛选器样式 */
        .category-filter {
            position: relative;
            width: 200px;
        }

        .category-filter select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            color: #2c3e50;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 45px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
            padding-right: 45px;
        }

        .category-filter select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .category-filter select:hover {
            border-color: #007bff;
        }

        /* 重置默认样式 */
        .category-filter select::-ms-expand {
            display: none;
        }

        /* 美化下拉选项 */
        .category-filter select option {
            padding: 12px 15px;
            font-size: 14px;
            color: #2c3e50;
            background-color: white;
            border: none;
        }

        /* 选项悬停和选中状态 */
        .category-filter select option:hover,
        .category-filter select option:focus {
            background-color: #007bff;
            color: white;
        }

        .category-filter select option:checked {
            background: linear-gradient(0deg, #007bff 0%, #007bff 100%);
            color: white;
            font-weight: 500;
        }

        /* 禁用状态 */
        .category-filter select:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .category-filter select option:disabled {
            color: #999;
            background-color: #f8f9fa;
        }

        /* 添加选择框的激活状态效果 */
        .category-filter::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* 自定义滚动条 */
        .category-filter select {
            scrollbar-width: thin;
            scrollbar-color: #007bff #f0f0f0;
        }

        .category-filter select::-webkit-scrollbar {
            width: 8px;
        }

        .category-filter select::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .category-filter select::-webkit-scrollbar-thumb {
            background-color: #007bff;
            border-radius: 4px;
            border: 2px solid #f0f0f0;
        }

        .category-filter select::-webkit-scrollbar-thumb:hover {
            background-color: #0056b3;
        }

        /* 适配深色模式 */
        @media (prefers-color-scheme: dark) {
            .category-filter select {
                background-color: #2c3e50;
                color: white;
                border-color: #4a5568;
            }
            
            .category-filter select option {
                background-color: #2c3e50;
                color: white;
            }
            
            .category-filter select option:checked {
                background: linear-gradient(0deg, #007bff 0%, #007bff 100%);
            }
        }

        /* 添加动画效果 */
        .category-filter select {
            transform-origin: top;
            transition: all 0.2s ease;
        }

        .category-filter select:focus {
            transform: scale(1.01);
        }

        /* 链接列表样式 */
        .links-container {
            margin-top: 20px;
        }

        .category-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .category-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            cursor: move; /* 添加移动光标 */
            user-select: none; /* 防止文本被选中 */
        }

        .category-title span {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
        }

        .category-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            height: 100%;
        }

        .links-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
        }

        .link-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            width: fit-content;  /* 根据内容自适应宽度 */
            min-width: 150px;  /* 最小宽度 */
        }

        .link-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .link-content {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            width: fit-content;  /* 根据内容自适应宽度 */
        }

        .link-favicon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .link-info {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .link-title {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;  /* 保持在一行 */
            width: fit-content;  /* 根据内容自适应宽度 */
        }

        .link-description {
            color: #6c757d;
            font-size: 14px;
            white-space: nowrap;  /* 保持在一行 */
            width: fit-content;  /* 根据内容自适应宽度 */
        }

        .link-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
            width: 100%;  /* 按钮容器占满卡片宽度 */
        }

        .edit-button,
        .delete-button {
            width: 60px;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .edit-button {
            background: #4CAF50;
            color: white;
        }

        .edit-button:hover {
            background: #45a049;
        }

        .delete-button {
            background: #ff4444;
            color: white;
        }

        .delete-button:hover {
            background: #ff1111;
        }

        /* 工具栏区域样式 */
        .tools-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 320px;
        }

        .section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f2f5;
        }

        /* 表单样式 */
        .category-form, .link-form, .note-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
        }

        input[type="text"], 
        input[type="url"], 
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        input[type="text"]:focus, 
        input[type="url"]:focus, 
        textarea:focus {
            border-color: #3b82f6;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 按钮样式 */
        .add-button, 
        .add-link-button, 
        .add-note-button,
        .action-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #3b82f6;
            color: white;
            font-size: 14px;
            text-align: center;
            width: 100%;
        }

        .add-button:hover, 
        .add-link-button:hover, 
        .add-note-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        /* 工具箱按钮样式 */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-button {
            background: #f1f5f9;
            color: #475569;
            font-weight: 500;
        }

        .action-button:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* 下拉菜单样式 - 恢复原始功能 */
        .custom-select {
            position: relative;
        }

        .selected-option {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 2px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.selected {
            background: #e9ecef;
        }

        /* 笔记编辑器样式 */
        .note-form textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .tools-section {
                width: 100%;
                padding: 16px;
            }
        }

        /* Toast提示样式 */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 12px 24px;
            border-radius: 8px;
            margin: 10px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease forwards;
            font-size: 16px;
            font-weight: 500;
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #007bff;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        /* 侧边栏导航样式 */
        .category-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-nav-item {
            margin-bottom: 10px;
        }

        .category-nav-header {
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .category-nav-header:hover {
            background: #e9ecef;
        }

        .category-nav-header.active {
            background: #007bff !important;
            color: white !important;
        }

        .category-nav-toggle {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .category-nav-toggle.expanded {
            transform: rotate(90deg);
        }

        .category-nav-links {
            display: none;
            padding: 8px 15px;
        }

        .category-nav-links.expanded {
            display: block;
        }

        .category-nav-link {
            display: block;
            padding: 8px 15px;
            margin: 5px 0;
            color: #2c3e50;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .category-nav-link:hover {
            background: #f8f9fa;
            color: #007bff;
        }

        .category-nav-divider {
            height: 1px;
            background: #e1e8ed;
            margin: 15px 0;
        }

        /* 侧边栏样式 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow-y: auto;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .nav-links {
            padding: 15px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            gap: 10px;
            order: -1;  /* 将导航链接移到顶部 */
        }

        .nav-links a {
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            color: #2c3e50;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .nav-links a:hover {
            background: #f8f9fa;
        }

        .nav-links a.active {
            background: #007bff;
            color: white;
        }

        .category-nav {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            margin: 0;
        }

        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 0 5px 5px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-toggle i {
            border: solid #2c3e50;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 4px;
            transition: transform 0.3s ease;
        }

        /* 主要内容区域样式 */
        .main-wrapper {
            margin-left: 250px;
            padding: 0;
            transition: margin-left 0.3s ease;
        }

        .sidebar-collapsed .main-wrapper {
            margin-left: 0;
        }

        /* 标题样式 */
        h1 {
            font-size: 36px;
            color: #2c3e50;
            text-align: center;
            margin: 15px 0;
            font-weight: 700;
        }

        /* 空状态提示 */
        .empty-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* 编辑对话框样式 */
        .edit-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .edit-dialog {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .edit-dialog-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .edit-form-group {
            margin-bottom: 15px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .edit-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .edit-form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .edit-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .edit-dialog-button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .edit-dialog-cancel {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .edit-dialog-cancel:hover {
            background: #e9ecef;
        }

        .edit-dialog-confirm {
            background: #007bff;
            color: white;
        }

        .edit-dialog-confirm:hover {
            background: #0056b3;
        }

        /* 工具栏区域样式 */
        .tools-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .category-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-edit-button,
        .category-delete-button {
            width: 60px;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-align: center;
            color: white;
        }

        .category-edit-button {
            background: #4CAF50;
        }

        .category-edit-button:hover {
            background: #45a049;
        }

        .category-delete-button {
            background: #ff4444;
        }

        .category-delete-button:hover {
            background: #ff1111;
        }

        .links-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
        }

        .search-container {
            background: white;
            padding: 20px;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 2px solid #f0f0f0;
            margin: 0;
            position: sticky;
            top: 84px;  /* 搜索框的高度 + padding */
            z-index: 99;
        }

        /* 添加一个小阴影效果，让固定头部更加明显 */
        .links-header {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .sort-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
        }

        .sort-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .sort-button:hover {
            background: #e9ecef;
        }

        .sort-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .sort-button.desc .sort-icon {
            transform: rotate(180deg);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-ghost {
            opacity: 0.5;
            background: #f8f9fa;
        }

        .category-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.15s ease;
        }

        .categories-container {
            margin-top: 20px;
        }

        /* 自定义确认对话框样式 */
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .confirm-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
            animation: slideIn 0.3s ease;
        }

        .confirm-dialog-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .confirm-dialog-content {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirm-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .confirm-dialog-button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .confirm-dialog-cancel {
            background: #f7fafc;
            color: #4a5568;
        }

        .confirm-dialog-cancel:hover {
            background: #edf2f7;
        }

        .confirm-dialog-confirm {
            background: #3182ce;
            color: white;
        }

        .confirm-dialog-confirm:hover {
            background: #2c5282;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 自定义下拉框样式 */
        .custom-select {
            position: relative;
            width: 200px;
            user-select: none;
        }

        .selected-option {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            color: #2c3e50;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding-right: 45px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-option::after {
            content: '';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: transform 0.3s ease;
        }

        .custom-select.open .selected-option::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .custom-select.open .dropdown-menu {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        .dropdown-item {
            padding: 12px 15px;
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #007bff;
        }

        .dropdown-item.selected {
            background-color: #007bff;
            color: white;
        }

        /* 自定义滚动条 */
        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .link-form .custom-select {
            width: 100%;
        }

        .link-form .selected-option {
            width: 100%;
            box-sizing: border-box;
        }

        .link-form .dropdown-menu {
            width: 100%;
            box-sizing: border-box;
        }

        /* 笔记相关样式 */
        .notes-container {
            display: none;
            padding: 20px;
        }

        .notes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        /* 笔记项样式 */
        .note-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            height: fit-content;
        }

        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .note-item h3 {
            margin: 0 0 10px 0;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .note-item p {
            margin: 0 0 10px 0;
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .note-item .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .note-item .tags span {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .note-item .note-time {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 10px;
        }

        /* 拖动模式下的笔记样式 */
        .note-item.draggable {
            cursor: move;
            padding-left: 30px;
        }

        .note-item.draggable::before {
            content: '⋮⋮';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-size: 20px;
            opacity: 0.7;
        }

        .note-card .note-content {
            color: #4a5568;
            margin: 0;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 15px;
            padding: 0;
            height: auto;
            max-height: 500px;    /* 设置最大高度，超出显示滚动条 */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }

        /* 当内容较短时的样式 */
        .note-card.short-content {
            min-height: 120px;
        }

        /* 当内容较长时的样式 */
        .note-card.long-content {
            height: auto;
        }

        .note-card .note-tags {
            color: #4299e1;
            font-size: 0.9em;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .note-card .note-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .note-card .note-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .note-card .edit-note {
            background: #38a169;
            color: white;
        }

        .note-card .edit-note:hover {
            background: #2f855a;
        }

        .note-card .delete-note {
            background: #e53e3e;
            color: white;
        }

        .note-card .delete-note:hover {
            background: #c53030;
        }

        @keyframes highlight {
            0% {
                background-color: #fff7e6;
                transform: scale(1.02);
            }
            50% {
                background-color: #fff7e6;
                transform: scale(1.02);
            }
            100% {
                background-color: white;
                transform: scale(1);
            }
        }

        .note-card[data-note-id] {
            transition: all 0.3s ease;
        }

        .note-card .note-tags {
            color: #007bff;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .highlighted-tag {
            background-color: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px;
        }

        /* 添加标签搜索相关的样式 */
        .search-options {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 15px;
        }

        .radio-group {
            display: flex;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .radio-label:hover {
            background: #e9ecef;
        }

        .radio-label input[type="radio"] {
            margin: 0;
        }

        .note-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .note-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .edit-note {
            background: #28a745;
            color: white;
        }

        .delete-note {
            background: #dc3545;
            color: white;
        }

        .note-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .note-form textarea {
            width: 100%;
            min-height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .note-form input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .note-form button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .note-form button:hover {
            background: #0056b3;
        }

        /* 添加新的样式 */
        .main-content {
            flex: 1;
            background: white;
            border-radius: 16px;
        }

        .notes-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
        }

        .tool-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .add-note-button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-note-button:hover {
            background: #0056b3;
        }

        /* 添加笔记拖拽相关样式 */
        .note-card {
            cursor: move; /* 显示可拖动的光标 */
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .note-card-ghost {
            opacity: 0.5;
            background: #f8f9fa;
        }

        /* 笔记排序按钮样式 */
        .notes-section .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #edf2f7;
        }

        .notes-section .header-controls h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #2d3748;
        }

        /* 修改拖动排序按钮样式 */
        .drag-sort-btn {
            padding: 5px 10px;
            background-color: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .drag-sort-btn:hover {
            background-color: #2d3748;
        }

        .drag-sort-btn.active {
            background-color: #48bb78;
        }

        /* 拖动模式下的笔记样式 */
        .note-item.draggable {
            cursor: move;
            position: relative;
        }

        .note-item.draggable::before {
            content: '⋮⋮';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-size: 20px;
            opacity: 0.7;
        }

        .links-section {
            background: white;
            border-radius: 16px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- 添加确认对话框HTML结构 -->
    <div id="confirmDialog" class="confirm-dialog-overlay" style="display: none;">
        <div class="confirm-dialog">
            <div class="confirm-dialog-title">确认删除</div>
            <div class="confirm-dialog-content"></div>
            <div class="confirm-dialog-buttons">
                <button class="confirm-dialog-button confirm-dialog-cancel" onclick="closeConfirmDialog()">取消</button>
                <button class="confirm-dialog-button confirm-dialog-confirm" onclick="handleConfirm()">确定</button>
            </div>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i></i>
        </div>
        <div class="nav-links">
            <a href="#" class="active" onclick="showLinks()">链接</a>
            <a href="#" onclick="showNotes()">笔记</a>
        </div>
        <ul class="category-nav" id="categoryNav">
            <!-- 分类导航将通过 JavaScript 动态生成 -->
        </ul>
    </div>

    <div class="main-wrapper">
        <h1>TC</h1>
        
        <!-- 主要内容区域 -->
        <div class="content-grid">
            <!-- 左侧内容区域 -->
            <div class="main-content">
                <!-- 链接管理界面 -->
                <div id="linksContainer" class="links-section">
                    <div class="links-header">
                        <div class="search-container">
                            <input type="text" class="search-input" id="searchInput" placeholder="搜索链接...">
                            <div class="search-options">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="search-engine" value="baidu" checked>
                                        百度
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="search-engine" value="google">
                                        谷歌
                                    </label>
                                </div>
                            </div>
                            <button class="search-button" onclick="searchLinks()">搜索</button>
                        </div>
                    </div>
                    <div class="section-header">
                        <h1 class="section-title">链接列表</h1>
                        <div class="header-controls">
                            <button class="sort-button" onclick="toggleCategorySort()" title="切换排序方向">
                                <span class="sort-icon">↓</span>
                            </button>
                            <div class="category-filter">
                                <div class="custom-select" onclick="toggleDropdown(event)">
                                    <div class="selected-option">显示所有分类</div>
                                    <div class="dropdown-menu">
                                        <div class="dropdown-item selected" data-value="all">显示所有分类</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="links-container">
                        <!-- 链接列表将通过 JavaScript 动态生成 -->
                    </div>
                </div>

                <!-- 笔记管理界面 -->
                <div id="notesContainer" class="notes-section" style="display: none;">
                    <div class="notes-header">
                        <div class="search-container">
                            <input type="text" class="search-input" id="noteSearchInput" placeholder="搜索笔记内容...">
                            <div class="search-options">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="search-type" value="content" checked>
                                        内容
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="search-type" value="tag">
                                        标签
                                    </label>
                                </div>
                            </div>
                            <button class="search-button" onclick="searchNotes()">搜索</button>
                        </div>
                    </div>
                    <div class="section-header">
                        <h1 class="section-title">笔记列表</h1>
                        <div class="header-controls">
                            <button class="sort-button" onclick="toggleNoteSort()" title="切换排序方向">
                                <span class="sort-icon">↓</span>
                            </button>
                            <button id="dragSortBtn" class="drag-sort-btn">启用拖动排序</button>
                        </div>
                    </div>
                    <div id="notesList" class="notes-list">
                        <!-- 笔记列表将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>

            <!-- 右侧工具栏 -->
            <div class="tools-section">
                <!-- 链接管理工具 -->
                <div id="linkTools" class="tool-container">
                <!-- 添加分类 -->
                <div class="section">
                    <h2 class="section-title">添加新分类</h2>
                    <div class="category-form">
                        <input type="text" class="category-input" id="categoryInput" placeholder="请输入分类名称...">
                        <button class="add-button" onclick="categoryManager.addCategory()">创建分类</button>
                    </div>
                </div>

                <!-- 添加链接 -->
                <div class="section">
                    <h2 class="section-title">添加新链接</h2>
                    <div class="link-form">
                        <div class="form-group">
                            <label>选择分类</label>
                                <div class="custom-select" onclick="toggleDropdown(event)">
                                    <div class="selected-option">请选择分类...</div>
                                    <div class="dropdown-menu">
                                        <!-- 分类选项将通过JavaScript动态添加 -->
                                    </div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label for="titleInput">网站名称</label>
                            <input type="text" id="titleInput" class="title-input" placeholder="请输入网站名称...">
                        </div>
                        <div class="form-group">
                            <label for="urlInput">网站地址</label>
                            <input type="url" id="urlInput" class="url-input" placeholder="请输入网站地址...">
                        </div>
                        <div class="form-group">
                            <label for="descriptionInput">简短描述</label>
                            <input type="text" id="descriptionInput" class="description-input" placeholder="请输入简短描述...">
                        </div>
                        <button class="add-link-button" onclick="linkManager.addLink()">添加链接</button>
                    </div>
                </div>

                <!-- 工具箱 -->
                <div class="section">
                    <h2 class="section-title">工具箱</h2>
                    <div class="action-buttons">
                            <button class="action-button" onclick="exportTemplate()">导入示例</button>
                        <button class="action-button" onclick="importLinks()">导入链接</button>
                        <button class="action-button" onclick="exportLinks()">导出链接</button>
                        <button class="action-button" onclick="checkLinks()">检查链接</button>
                    </div>
                </div>
            </div>

                <!-- 笔记管理工具 -->
                <div id="noteTools" class="tool-container" style="display: none;">
                    <!-- 添加笔记 -->
                    <div class="section">
                        <h2 class="section-title">添加新笔记</h2>
                        <div class="note-form">
                            <div class="form-group">
                                <label for="noteTitle">笔记标题</label>
                                <input type="text" id="noteTitle" placeholder="请输入标题...">
                            </div>
                            <div class="form-group">
                                <label for="noteContent">笔记内容</label>
                                <textarea id="noteContent" placeholder="请输入内容..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="noteTags">标签</label>
                                <input type="text" id="noteTags" placeholder="用逗号分隔多个标签...">
                            </div>
                            <button class="add-note-button" onclick="noteManager.addNote()">添加笔记</button>
                        </div>
                    </div>

                    <!-- 笔记工具箱 -->
                    <div class="section">
                        <h2 class="section-title">笔记工具</h2>
                        <div class="action-buttons">
                            <button class="action-button" onclick="noteManager.exportNotes()">导出笔记</button>
                            <button class="action-button" onclick="noteManager.importNotes()">导入笔记</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container"></div>

    <script>
        // 定义基础URL
        const baseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000'
            : window.location.origin;

        // 默认favicon
        const defaultFaviconUrl = '/favicon.svg';

        // 全局变量声明
        let isCategoryDescSort = false; // 默认升序排序
        let expandedCategory = null; // 当前展开的分类
        let currentSelectedCategory = 'all'; // 当前选中的分类
        let currentExpandedCategory = null; // 当前展开的分类

        // 处理favicon URL的辅助函数
        function getFaviconUrl(favicon) {
            console.log('[getFaviconUrl] 开始处理favicon:', favicon);
            if (!favicon) {
                console.log('[getFaviconUrl] favicon为空，返回默认图标');
                return '/favicon.svg';
            }
            
            // 如果是相对路径，添加baseUrl
            if (!favicon.startsWith('http')) {
                const result = baseUrl + favicon;
                console.log('[getFaviconUrl] 转换相对路径:', favicon, '->', result);
                return result;
            }
            
            console.log('[getFaviconUrl] 使用原始favicon:', favicon);
            return favicon;
        }

        // 记录访问次数
        async function recordVisit(linkId) {
            try {
                await fetch(`${baseUrl}/api/links/${linkId}/visit`, { method: 'POST' });
            } catch (error) {
                console.error('记录访问失败:', error);
            }
        }

        // 删除链接
        async function deleteLink(linkId) {
            showConfirmDialog('确定要删除这个链接吗？', async () => {
                try {
                    const response = await fetch(`${baseUrl}/api/links/${encodeURIComponent(linkId)}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error('删除链接失败');
                    }

                    // 使用reloadCategoriesWithSort替代loadCategories
                    await reloadCategoriesWithSort(null, 'all');
                    
                    // 切换到"显示所有分类"视图
                    const allCategoriesHeader = document.querySelector('#categoryNav li:first-child .category-nav-header');
                    if (allCategoriesHeader) {
                        allCategoriesHeader.click();
                    }
                    
                    showToast('链接删除成功！');
                } catch (error) {
                    console.error('删除链接失败:', error);
                    showToast('删除链接失败: ' + error.message, 'error');
                }
            });
        }

        // 搜索功能
        function searchLinks() {
            const query = document.querySelector('.search-input').value;
            const engine = document.querySelector('input[name="search-engine"]:checked').value;
            const baseUrl = engine === 'baidu' ? 'https://www.baidu.com/s?wd=' : 'https://www.google.com/search?q=';
            window.open(baseUrl + encodeURIComponent(query), '_blank');
        }

        // Toast 提示函数
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => toastContainer.removeChild(toast), 300);
            }, 3000);
        }

        // 工具函数
        const utils = {
            showToast(message, type = 'success') {
                showToast(message, type);
            },

            async fetchAPI(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('API请求失败:', error);
                    this.showToast(error.message, 'error');
                    throw error;
                }
            }
        };

        // 链接管理
        const linkManager = {
            isSubmitting: false, // 添加提交状态标记

            async addLink() {
                if (this.isSubmitting) {
                    showToast('正在提交中，请稍候...', 'info');
                    return;
                }

                const selectedOption = document.querySelector('.link-form .selected-option');
                const category = selectedOption.getAttribute('data-value');
                const title = document.getElementById('titleInput').value.trim();
                const url = document.getElementById('urlInput').value.trim();
                const description = document.getElementById('descriptionInput').value.trim();

                if (!this.validateLinkInput(category, title, url)) return;

                try {
                    this.isSubmitting = true;
                    const addButton = document.querySelector('.add-link-button');
                    addButton.disabled = true;
                    addButton.style.backgroundColor = '#ccc';
                    addButton.style.cursor = 'not-allowed';
                    showToast('正在添加链接，请稍候...', 'info');

                    const response = await fetch(`${baseUrl}/api/links`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category, title, url, description })
                    });

                    if (!response.ok) {
                        throw new Error('添加链接失败');
                    }

                    const result = await response.json();
                    
                    // 添加成功后，自动更新favicon
                    if (result.link && result.link.id) {
                        await updateLinkFavicon(result.link.id);
                    }

                    this.clearLinkForm();
                    await loadLinks(category);
                    utils.showToast('链接添加成功！');
                } catch (error) {
                    utils.showToast('添加链接失败: ' + error.message, 'error');
                } finally {
                    this.isSubmitting = false;
                    const addButton = document.querySelector('.add-link-button');
                    addButton.disabled = false;
                    addButton.style.backgroundColor = '';
                    addButton.style.cursor = 'pointer';
                }
            },

            validateLinkInput(category, title, url) {
                if (!category) {
                    utils.showToast('请选择分类', 'error');
                    return false;
                }
                if (!title) {
                    utils.showToast('请输入网站名称', 'error');
                    return false;
                }
                if (!url) {
                    utils.showToast('请输入网站地址', 'error');
                    return false;
                }
                return true;
            },

            clearLinkForm() {
                const selectedOption = document.querySelector('.link-form .selected-option');
                selectedOption.textContent = '请选择分类...';
                selectedOption.removeAttribute('data-value');
                document.getElementById('titleInput').value = '';
                document.getElementById('urlInput').value = '';
                document.getElementById('descriptionInput').value = '';
            }
        };

        // 分类管理
        const categoryManager = {
            isSubmitting: false, // 添加提交状态标记

            async addCategory() {
                // 如果正在提交中，直接返回
                if (this.isSubmitting) {
                    showToast('正在创建分类，请稍候...', 'info');
                    return;
                }

                const categoryInput = document.getElementById('categoryInput');
                const category = categoryInput.value.trim();
                
                if (!category) {
                    utils.showToast('请输入分类名称', 'error');
                    return;
                }

                try {
                    // 设置提交状态为true
                    this.isSubmitting = true;
                    // 禁用添加按钮
                    const addButton = document.querySelector('.add-button');
                    addButton.disabled = true;
                    addButton.style.backgroundColor = '#ccc';
                    addButton.style.cursor = 'not-allowed';
                    // 显示提交中的提示
                    showToast('正在创建分类，请稍候...', 'info');

                    await utils.fetchAPI(`${baseUrl}/api/categories`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category })
                    });

                    categoryInput.value = '';
                    await this.refreshCategories();
                    utils.showToast('分类创建成功！');
                } catch (error) {
                    utils.showToast('添加分类失败: ' + error.message, 'error');
                } finally {
                    // 重置提交状态
                    this.isSubmitting = false;
                    // 恢复添加按钮
                    const addButton = document.querySelector('.add-button');
                    addButton.disabled = false;
                    addButton.style.backgroundColor = '';
                    addButton.style.cursor = 'pointer';
                }
            },

            async refreshCategories() {
                // 直接使用reloadCategoriesWithSort，避免重复调用
                await reloadCategoriesWithSort(null, 'all');
            }
        };

        // 更新分类过滤器变化处理函数
        function handleCategoryFilterChange(category) {
            console.log('分类选择器变化，选中分类:', category);
            console.log('当前排序状态:', isCategoryDescSort ? '降序' : '升序');

            if (category === 'all') {
                console.log('选择了"显示所有分类"');
                // 直接加载所有链接
                loadLinks('all');
                
                // 更新侧边栏导航的选中状态
                const categoryHeaders = document.querySelectorAll('.category-nav-header');
                categoryHeaders.forEach(header => header.classList.remove('active'));
                const allCategoriesHeader = document.querySelector('#categoryNav li:first-child .category-nav-header');
                if (allCategoriesHeader) {
                    allCategoriesHeader.classList.add('active');
                }
            } else {
                console.log('选择了特定分类:', category);
                // 找到对应的分类并点击
                const categoryHeaders = document.querySelectorAll('.category-name');
                console.log('找到的分类标题数量:', categoryHeaders.length);
                
                let found = false;
                categoryHeaders.forEach(header => {
                    if (header.textContent === category) {
                        console.log('找到匹配的分类:', category);
                        const categoryHeader = header.closest('.category-nav-header');
                        if (categoryHeader) {
                            console.log('触发分类点击事件');
                            categoryHeader.click();
                            found = true;
                        }
                    }
                });
                
                if (!found) {
                    console.log('未找到匹配的分类，直接加载链接');
                    loadLinks(category);
                }
            }
            scrollToTop();
        }

        // 切换分类排序
        async function toggleCategorySort() {
            console.log('toggleCategorySort 被调用');
            console.log('排序前状态:', isCategoryDescSort);
            
            // 切换排序状态
            isCategoryDescSort = !isCategoryDescSort;
            console.log('切换后的排序状态:', isCategoryDescSort);
            
            // 更新排序按钮样式
            console.log('更新排序按钮样式');
            const sortButton = document.querySelector('#linksContainer .sort-button');
            sortButton.classList.toggle('desc', isCategoryDescSort);
            
            // 更新排序图标方向
            console.log('更新排序图标方向');
            const sortIcon = sortButton.querySelector('.sort-icon');
            sortIcon.style.transform = isCategoryDescSort ? 'rotate(0deg)' : 'rotate(180deg)';

            // 获取当前选中的分类
            const selectedOption = document.querySelector('.selected-option');
            currentSelectedCategory = selectedOption.textContent === '显示所有分类' ? 'all' : selectedOption.textContent;
            console.log('当前选中的分类:', currentSelectedCategory);

            // 重新加载分类
            await reloadCategoriesWithSort(expandedCategory, currentSelectedCategory);
            
            // 显示排序提示
            utils.showToast(`分类已${isCategoryDescSort ? '降序' : '升序'}排列`);
        }

        // 添加滚动到顶部函数
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // 重新加载分类（带排序）
        async function reloadCategoriesWithSort(expandedCategory = null, selectedCategory = 'all') {
            console.log('reloadCategoriesWithSort 开始执行');
            console.log('参数 - expandedCategory:', expandedCategory);
            console.log('参数 - selectedCategory:', selectedCategory);
            console.log('当前排序方向:', isCategoryDescSort ? 'desc' : 'asc');

            try {
                // 获取分类列表
                const response = await fetch(`/api/categories?sort=${isCategoryDescSort ? 'desc' : 'asc'}`);
                console.log('API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error('获取分类失败');
                }
                
                const categories = await response.json();
                console.log('获取到的分类数据:', categories);
                
                // 更新分类过滤器
                console.log('更新分类过滤器');
                const dropdownMenu = document.querySelector('.category-filter .dropdown-menu');
                dropdownMenu.innerHTML = `
                    <div class="dropdown-item ${selectedCategory === 'all' ? 'selected' : ''}" data-value="all">
                        显示所有分类
                    </div>
                    ${categories.map(category => `
                        <div class="dropdown-item ${selectedCategory === category ? 'selected' : ''}" data-value="${category}">
                            ${category}
                        </div>
                    `).join('')}
                `;

                // 更新添加链接表单的分类选择器
                const addLinkDropdownMenu = document.querySelector('.link-form .dropdown-menu');
                if (addLinkDropdownMenu) {
                    console.log('更新添加链接表单的分类选择器');
                    addLinkDropdownMenu.innerHTML = categories.map(category => `
                        <div class="dropdown-item" data-value="${category}">
                            ${category}
                        </div>
                    `).join('');
                }

                // 更新侧边栏导航
                const categoryNav = document.getElementById('categoryNav');
                const isNotesView = document.getElementById('notesContainer').style.display !== 'none';
                
                if (isNotesView) {
                    // 笔记视图的导航栏
                    categoryNav.innerHTML = `
                        <li class="category-nav-item">
                            <div class="category-nav-header active" onclick="handleCategoryClick(event, 'notes')">
                                <span class="category-name">我的笔记</span>
                            </div>
                        </li>
                    `;
                } else {
                    // 链接视图的导航栏
                    categoryNav.innerHTML = `
                        <li class="category-nav-item">
                            <div class="category-nav-header ${selectedCategory === 'all' ? 'active' : ''}" onclick="handleCategoryClick(event, 'all')">
                                <span class="category-name">全部分类</span>
                                <span class="link-count">${categories.length}</span>
                            </div>
                        </li>
                        ${categories.map(category => `
                            <li class="category-nav-item">
                                <div class="category-nav-header ${category === selectedCategory ? 'active' : ''}" onclick="handleCategoryClick(event, '${category}')">
                                    <span class="category-name">${category}</span>
                                </div>
                            </li>
                        `).join('')}
                    `;
                }
                
                // 更新选中的选项显示
                const selectedOption = document.querySelector('.selected-option');
                selectedOption.textContent = selectedCategory === 'all' ? '显示所有分类' : selectedCategory;
                
                // 只在链接视图时重新加载链接列表
                if (!isNotesView) {
                    console.log('重新加载链接列表，使用分类:', selectedCategory);
                    await loadLinks(selectedCategory);
                }
                
                console.log('reloadCategoriesWithSort 执行完成');
            } catch (error) {
                console.error('重新加载分类失败:', error);
                utils.showToast('重新加载分类失败', 'error');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('开始初始化...');
                // 使用reloadCategoriesWithSort来完成初始化
                await reloadCategoriesWithSort(null, 'all');
                // 确保默认显示链接管理界面
                showLinks();
                console.log('初始化完成');
            } catch (error) {
                console.error('初始化失败:', error);
                alert('初始化失败: ' + error.message);
            }
        });

        // 修改categoryManager的refreshCategories方法
        Object.assign(categoryManager, {
            async refreshCategories() {
                // 直接使用reloadCategoriesWithSort，避免重复调用
                await reloadCategoriesWithSort(null, 'all');
            }
        });

        // 修改showLinks函数
        function showLinks() {
            // 显示链接相关内容
            document.getElementById('linksContainer').style.display = 'block';
            document.getElementById('linkTools').style.display = 'block';
            
            // 隐藏笔记相关内容
            document.getElementById('notesContainer').style.display = 'none';
            document.getElementById('noteTools').style.display = 'none';
            
            // 更新导航栏状态
            document.querySelector('.nav-links a.active').classList.remove('active');
            document.querySelector('.nav-links a:first-child').classList.add('active');

            // 显示所有导航项，但隐藏笔记相关项
            const categoryNav = document.getElementById('categoryNav');
            categoryNav.style.display = 'block';
            categoryNav.querySelectorAll('.category-nav-item').forEach(item => {
                const categoryName = item.querySelector('.category-name');
                if (categoryName && categoryName.textContent.includes('我的笔记')) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'block';
                }
            });
            
            // 隐藏第一个分隔线（笔记下方的分隔线）
            const firstDivider = categoryNav.querySelector('.category-nav-divider');
            if (firstDivider) {
                firstDivider.style.display = 'none';
            }

            // 确保"全部分类"保持选中状态，但不触发额外的加载
            const allCategoriesHeader = Array.from(categoryNav.querySelectorAll('.category-nav-header'))
                .find(header => header.textContent.includes('全部分类'));
            if (allCategoriesHeader) {
                categoryNav.querySelectorAll('.category-nav-header').forEach(header => {
                    if (header !== allCategoriesHeader && !header.querySelector('.category-name')?.textContent.includes('我的笔记')) {
                        header.classList.remove('active');
                    }
                });
                allCategoriesHeader.classList.add('active');
            }
        }

        // 修改loadLinks函数
        async function loadLinks(category = 'all') {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`${baseUrl}/api/links/${encodeURIComponent(category)}?t=${timestamp}`);
                if (!response.ok) {
                    throw new Error('获取链接失败');
                }
                const links = await response.json();
                await filterLinksByCategory(category);
            } catch (error) {
                console.error('加载链接失败:', error);
                showToast('加载链接失败: ' + error.message, 'error');
            }
        }

        // 移除loadCategories函数的重复调用
        async function loadCategories() {
            console.log('loadCategories被调用，但已被禁用以避免重复加载');
            return;
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            let isProcessing = false;
            return async function executedFunction(...args) {
                // 如果正在处理中，直接返回
                if (isProcessing) {
                    console.log('正在处理中，跳过重复请求');
                    return;
                }

                const later = async () => {
                    try {
                        isProcessing = true;
                        console.log('开始执行防抖后的请求');
                        await func.apply(this, args);
                    } finally {
                        isProcessing = false;
                        timeout = null;
                        console.log('请求处理完成');
                    }
                };

                console.log('收到新的请求，重置定时器');
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 加载指定分类的链接
        const debouncedFilterLinks = debounce(filterLinksByCategory, 300);
        
        async function loadLinks(category = 'all') {
            console.log(`loadLinks 被调用，参数: ${category}`);
            try {
                // 直接调用 filterLinksByCategory，不使用防抖
                await filterLinksByCategory(category);
            } catch (error) {
                console.error('加载链接失败:', error);
                showToast('加载链接失败: ' + error.message, 'error');
            }
        }

        // 导入链接
        let isImporting = false;
        async function importLinks() {
            if (isImporting) {
                showToast('正在导入链接，请稍候...', 'info');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    isImporting = true;
                    // 禁用所有工具箱按钮
                    const toolButtons = document.querySelectorAll('.action-button');
                    toolButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.backgroundColor = '#ccc';
                        btn.style.cursor = 'not-allowed';
                    });
                    // 显示导入中的提示
                    showToast('正在导入链接，请稍候...', 'info');

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const links = JSON.parse(event.target.result);
                        const response = await fetch(`${baseUrl}/api/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ links })
                        });
                            
                        if (response.ok) {
                                // 等待所有重新加载操作完成
                                try {
                                    // 重新加载分类
                            await loadCategories();
                                    // 更新侧边栏导航
                                    await updateSidebarNav();
                                    // 重新加载所有链接
                                    await loadLinks('all');
                                    // 切换到"显示所有分类"视图
                                    const allCategoriesHeader = document.querySelector('#categoryNav li:first-child .category-nav-header');
                                    if (allCategoriesHeader) {
                                        allCategoriesHeader.click();
                                    }

                                    // 创建导入结果对话框
                                    const resultDialog = document.createElement('div');
                                    resultDialog.className = 'confirm-dialog-overlay';
                                    resultDialog.style.display = 'flex';
                                    resultDialog.innerHTML = `
                                        <div class="confirm-dialog" style="background: #2c3e50; color: white;">
                                            <div class="confirm-dialog-title" style="color: white; font-size: 22px; border-bottom: 2px solid #34495e; padding-bottom: 15px;">导入结果</div>
                                            <div class="confirm-dialog-content" style="padding: 20px 0;">
                                                <p style="font-size: 18px; color: white; margin-bottom: 20px;">导入成功！</p>
                                                <div style="display: grid; grid-template-columns: auto auto; gap: 10px; margin-bottom: 20px;">
                                                    <div style="text-align: right; color: #bdc3c7;">导入链接数量:</div>
                                                    <div style="color: #2ecc71;">${links.length}</div>
                                                    <div style="text-align: right; color: #bdc3c7;">导入分类:</div>
                                                    <div style="color: #2ecc71;">${[...new Set(links.map(link => link.category))].join(', ')}</div>
                                                </div>
                                            </div>
                                            <div class="confirm-dialog-buttons" style="border-top: 2px solid #34495e; padding-top: 15px;">
                                                <button class="confirm-dialog-button confirm-dialog-confirm" style="background: #3498db;" onclick="this.closest('.confirm-dialog-overlay').remove()">确定</button>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(resultDialog);
                                } catch (reloadError) {
                                    console.error('重新加载数据失败:', reloadError);
                                    showToast('导入成功，但重新加载数据失败，请刷新页面', 'error');
                                }
                        } else {
                            throw new Error('服务器响应错误');
                        }
                    } catch (error) {
                        console.error('导入链接失败:', error);
                            showToast('导入链接失败，请确保文件格式正确', 'error');
                    }
                };
                reader.readAsText(file);
                } catch (error) {
                    console.error('导入链接失败:', error);
                    showToast('导入链接失败: ' + error.message, 'error');
                } finally {
                    isImporting = false;
                    // 恢复所有工具箱按钮
                    const toolButtons = document.querySelectorAll('.action-button');
                    toolButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.backgroundColor = '';
                        btn.style.cursor = 'pointer';
                    });
                }
            };
            input.click();
        }

        // 导出链接
        let isExporting = false;
        async function exportLinks() {
            if (isExporting) {
                showToast('正在导出链接，请稍候...', 'info');
                return;
            }

            try {
                isExporting = true;
                // 禁用所有工具箱按钮
                const toolButtons = document.querySelectorAll('.action-button');
                toolButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.backgroundColor = '#ccc';
                    btn.style.cursor = 'not-allowed';
                });
                // 显示导出中的提示
                showToast('正在导出链接，请稍候...', 'info');

                const response = await fetch(`${baseUrl}/api/export`);
                if (!response.ok) {
                    throw new Error('导出失败');
                }
                const links = await response.json();
                const blob = new Blob([JSON.stringify(links, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'links.json';
                a.click();
                URL.revokeObjectURL(url);
                showToast('链接导出成功！');
            } catch (error) {
                console.error('导出链接失败:', error);
                showToast('导出链接失败: ' + error.message, 'error');
            } finally {
                isExporting = false;
                // 恢复所有工具箱按钮
                const toolButtons = document.querySelectorAll('.action-button');
                toolButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.backgroundColor = '';
                    btn.style.cursor = 'pointer';
                });
            }
        }

        // 检查链接
        let isChecking = false;
        async function checkLinks() {
            if (isChecking) {
                utils.showToast('正在检查链接，请稍候...', 'info');
                return;
            }

            try {
                isChecking = true;
                utils.showToast('开始检查链接...', 'info');
                console.log('开始检查链接...');

                // 创建遮罩层
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 9999;
                `;
                document.body.appendChild(overlay);

                // 显示进度对话框
                const progressDialog = document.createElement('div');
                progressDialog.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    z-index: 10000;
                    min-width: 300px;
                    max-width: 80%;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                progressDialog.innerHTML = `
                    <div class="dialog-content">
                        <h2 style="margin-bottom: 15px; color: #333;">检查链接</h2>
                        <p id="checkProgress" style="margin-bottom: 10px; color: #666;">正在检查链接有效性...</p>
                        <div style="background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
                            <div class="progress-bar-fill" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s;"></div>
                        </div>
                        <div id="checkResults" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                `;
                document.body.appendChild(progressDialog);

                // 更新进度条动画
                const progressBar = progressDialog.querySelector('.progress-bar-fill');
                progressBar.style.width = '30%';

                console.log('调用后端API检查链接...');
                // 调用后端API检查链接
                const response = await fetch(`${baseUrl}/api/check-links`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('检查链接失败');
                }

                progressBar.style.width = '70%';
                console.log('获取检查结果...');

                const data = await response.json();
                const results = data.results;
                console.log('检查结果:', results);

                // 统计结果
                const validLinks = results.filter(link => link.isValid);
                const invalidLinks = results.filter(link => !link.isValid);
                console.log(`有效链接: ${validLinks.length}, 无效链接: ${invalidLinks.length}`);

                progressBar.style.width = '100%';

                // 更新结果显示
                const resultsElement = document.getElementById('checkResults');
                if (invalidLinks.length > 0) {
                    resultsElement.innerHTML = `
                        <p style="color: #f44336; margin-bottom: 10px; font-weight: bold;">
                            检查完成！发现 ${invalidLinks.length} 个无效链接：
                        </p>
                        <ul style="list-style: none; padding: 0;">
                            ${invalidLinks.map(link => `
                                <li style="padding: 12px; background: #ffebee; margin-bottom: 8px; border-radius: 4px;">
                                    <div style="font-weight: bold; margin-bottom: 4px;">${link.title}</div>
                                    <div style="color: #666; word-break: break-all; font-size: 0.9em;">${link.url}</div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    utils.showToast(`发现 ${invalidLinks.length} 个无效链接`, 'warning');
                } else {
                    resultsElement.innerHTML = '<p style="color: #4CAF50; font-weight: bold;">所有链接检查完成，全部可用！</p>';
                    utils.showToast('所有链接检查完成，全部可用！', 'success');
                }

                // 5秒后自动关闭对话框
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(progressDialog);
                }, 5000);
            } catch (error) {
                console.error('检查链接失败:', error);
                utils.showToast('检查链接失败: ' + error.message, 'error');
            } finally {
                isChecking = false;
            }
        }

        // 编辑分类
        async function editCategory(oldCategory) {
            console.log('开始编辑分类:', oldCategory);
            const newCategory = prompt('请输入新的分类名称:', oldCategory);
            if (!newCategory) {
                showToast('分类名称不能为空', 'error');
                return;
            }
            
            if (newCategory === oldCategory) {
                showToast('新分类名称与原分类名称相同', 'info');
                return;
            }

            try {
                console.log('发送更新分类请求:', { oldCategory, newCategory });
                const response = await fetch(`${baseUrl}/api/categories/${encodeURIComponent(oldCategory)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newCategory })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '更新分类失败');
                }

                await loadCategories();
                await updateSidebarNav();
                await loadLinks('all');
                showToast(data.message || '分类更新成功！');
            } catch (error) {
                console.error('更新分类失败:', error);
                showToast('更新分类失败: ' + error.message, 'error');
            }
        }

        // 删除分类
        async function deleteCategory(category) {
            showConfirmDialog(`确定要删除分类"${category}"及其所有链接吗？`, async () => {
                try {
                    console.log('开始删除分类:', category);
                    const response = await fetch(`${baseUrl}/api/categories/${encodeURIComponent(category)}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('删除分类失败');
                    }

                    // 先清空链接容器
                    const linksContainer = document.querySelector('.links-container');
                    linksContainer.innerHTML = '<div class="empty-message">暂无任何链接，请点击右侧"添加新链接"开始添加</div>';

                    // 重置分类过滤器
                    const selectedOption = document.querySelector('.category-filter .selected-option');
                    if (selectedOption) {
                        selectedOption.textContent = '显示所有分类';
                        selectedOption.setAttribute('data-value', 'all');
                    }

                    // 重置添加链接表单的分类选择器
                    const addLinkSelectedOption = document.querySelector('.link-form .selected-option');
                    if (addLinkSelectedOption) {
                        addLinkSelectedOption.textContent = '请选择分类...';
                        addLinkSelectedOption.removeAttribute('data-value');
                    }

                    // 确保"全部分类"在侧边栏中被选中
                    const allCategoriesHeader = document.querySelector('#categoryNav li:first-child .category-nav-header');
                    if (allCategoriesHeader) {
                        const headers = document.querySelectorAll('.category-nav-header');
                        headers.forEach(h => h.classList.remove('active'));
                        allCategoriesHeader.classList.add('active');
                    }

                    // 获取最新的分类数据
                    const categoriesResponse = await fetch(`${baseUrl}/api/categories?sort=${isCategoryDescSort ? 'desc' : 'asc'}`);
                    if (!categoriesResponse.ok) {
                        throw new Error('获取分类失败');
                    }
                    const categories = await categoriesResponse.json();
                    console.log('删除后的分类列表:', categories);

                    // 更新分类过滤器
                    const filterDropdownMenu = document.querySelector('.category-filter .dropdown-menu');
                    if (filterDropdownMenu) {
                        filterDropdownMenu.innerHTML = `<div class="dropdown-item selected" data-value="all">显示所有分类</div>`;
                        categories.forEach(category => {
                            filterDropdownMenu.innerHTML += `
                                <div class="dropdown-item" data-value="${category}">${category}</div>
                            `;
                        });
                    }

                    // 更新添加链接表单的分类选择器
                    const addLinkDropdownMenu = document.querySelector('.link-form .dropdown-menu');
                    if (addLinkDropdownMenu) {
                        addLinkDropdownMenu.innerHTML = '';
                        categories.forEach(category => {
                            addLinkDropdownMenu.innerHTML += `
                                <div class="dropdown-item" data-value="${category}">${category}</div>
                            `;
                        });
                    }

                    // 更新侧边栏导航
                    await updateSidebarNav();

                    // 重新加载链接列表
                    await filterLinksByCategory('all');

                    showToast('分类删除成功！');
                } catch (error) {
                    console.error('删除分类失败:', error);
                    showToast('删除分类失败: ' + error.message, 'error');
                }
            });
        }

        // 添加初始化UI的函数
        async function initializeUI() {
            try {
                console.log('开始初始化UI...');
                
                // 获取最新的分类数据
                const categoriesResponse = await fetch(`${baseUrl}/api/categories?sort=${isCategoryDescSort ? 'desc' : 'asc'}`);
                if (!categoriesResponse.ok) {
                    throw new Error('获取分类失败');
                }
                const categories = await categoriesResponse.json();
                console.log('最新的分类数据:', categories);

                // 更新分类过滤器
                const filterDropdownMenu = document.querySelector('.category-filter .dropdown-menu');
                if (filterDropdownMenu) {
                    filterDropdownMenu.innerHTML = `<div class="dropdown-item selected" data-value="all">显示所有分类</div>`;
                    categories.forEach(category => {
                        filterDropdownMenu.innerHTML += `
                            <div class="dropdown-item" data-value="${category}">${category}</div>
                        `;
                    });
                }

                // 更新添加链接表单的分类选择器
                const addLinkDropdownMenu = document.querySelector('.link-form .dropdown-menu');
                if (addLinkDropdownMenu) {
                    addLinkDropdownMenu.innerHTML = '';
                    categories.forEach(category => {
                        addLinkDropdownMenu.innerHTML += `
                            <div class="dropdown-item" data-value="${category}">${category}</div>
                        `;
                    });
                }

                // 更新侧边栏导航
                await updateSidebarNav();

                // 重新加载链接列表
                await loadLinks('all');

                console.log('UI初始化完成');
            } catch (error) {
                console.error('初始化UI失败:', error);
                showToast('初始化UI失败: ' + error.message, 'error');
            }
        }

        // 编辑链接
        async function editLink(id, title, url, description) {
            const overlay = document.createElement('div');
            overlay.className = 'edit-dialog-overlay';
            
            overlay.innerHTML = `
                <div class="edit-dialog">
                    <div class="edit-dialog-title">编辑链接</div>
                    <div class="edit-form-group">
                        <label for="editTitle">网站名称</label>
                        <input type="text" id="editTitle" value="${title}">
                    </div>
                    <div class="edit-form-group">
                        <label for="editUrl">网站地址</label>
                        <input type="url" id="editUrl" value="${url}">
                    </div>
                    <div class="edit-form-group">
                        <label for="editDescription">简短描述</label>
                        <input type="text" id="editDescription" value="${description}">
                    </div>
                    <div class="edit-dialog-buttons">
                        <button class="edit-dialog-button edit-dialog-cancel" onclick="this.closest('.edit-dialog-overlay').remove()">取消</button>
                        <button class="edit-dialog-button edit-dialog-confirm" onclick="updateLink('${id}')">保存</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        // 更新链接
        async function updateLink(id) {
            const title = document.getElementById('editTitle').value.trim();
            const url = document.getElementById('editUrl').value.trim();
            const description = document.getElementById('editDescription').value.trim();

            if (!title || !url) {
                showToast('网站名称和地址不能为空', 'error');
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/api/links/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, url, description })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '更新失败');
                }

                // 关闭编辑对话框
                document.querySelector('.edit-dialog-overlay').remove();

                // 获取当前选中的分类
                const selectedOption = document.querySelector('.category-filter .selected-option');
                const currentCategory = selectedOption.getAttribute('data-value') || 'all';

                // 重新加载链接
                await loadLinks(currentCategory);
                showToast('链接更新成功！');
            } catch (error) {
                console.error('更新链接失败:', error);
                showToast('更新链接失败: ' + error.message, 'error');
            }
        }

        // 侧边栏收缩功能
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const body = document.body;
            const toggle = document.querySelector('.sidebar-toggle i');
            
            if (!sidebar || !body || !toggle) return;
            
            sidebar.classList.toggle('collapsed');
            body.classList.toggle('sidebar-collapsed');
            
            document.documentElement.style.setProperty(
                '--sidebar-width',
                sidebar.classList.contains('collapsed') ? '60px' : '250px'
            );
            
            toggle.style.transform = sidebar.classList.contains('collapsed') 
                ? 'rotate(-45deg)' 
                : 'rotate(135deg)';
        }

        // 初始化箭头方向
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.querySelector('.sidebar-toggle i');
            if (toggle) {
                toggle.style.transform = 'rotate(135deg)';
            }
        });

        // 更新侧边栏导航
        async function updateSidebarNav() {
            const nav = document.getElementById('categoryNav');
            nav.innerHTML = '';

            const categoryElements = new Map();

            try {
                // 添加笔记导航
                const notesLi = document.createElement('li');
                notesLi.className = 'category-nav-item';
                notesLi.innerHTML = `
                    <div class="category-nav-header">
                        <span class="category-nav-toggle">▶</span>
                        <span class="category-name">我的笔记</span>
                    </div>
                    <div class="category-nav-links"></div>
                `;

                // 根据当前视图设置笔记导航项的显示状态
                const isNotesView = document.getElementById('notesContainer').style.display === 'block';
                notesLi.style.display = isNotesView ? 'block' : 'none';

                const notesHeader = notesLi.querySelector('.category-nav-header');
                const notesToggle = notesLi.querySelector('.category-nav-toggle');
                const notesLinks = notesLi.querySelector('.category-nav-links');
                let notesLoaded = false;

                notesHeader.addEventListener('click', async () => {
                    // 移除所有分类的active类
                    nav.querySelectorAll('.category-nav-header').forEach(h => {
                        h.classList.remove('active');
                    });
                    // 添加active类到"我的笔记"
                    notesHeader.classList.add('active');

                    if (currentExpandedCategory === 'notes') {
                        notesToggle.classList.remove('expanded');
                        notesLinks.classList.remove('expanded');
                        currentExpandedCategory = null;
                        return;
                    }

                    if (currentExpandedCategory) {
                        const prevElement = categoryElements.get(currentExpandedCategory);
                        if (prevElement) {
                            prevElement.toggle.classList.remove('expanded');
                            prevElement.links.classList.remove('expanded');
                        }
                    }

                    notesToggle.classList.add('expanded');
                    notesLinks.classList.add('expanded');
                    currentExpandedCategory = 'notes';

                    if (!notesLoaded) {
                        try {
                            const response = await fetch(`${baseUrl}/api/notes`);
                            if (!response.ok) throw new Error('获取笔记失败');
                            
                            const notes = await response.json();
                            notesLinks.innerHTML = notes.map(note => `
                                <a href="#" class="category-nav-link" onclick="showNoteDetail(${note.id}); return false;" title="${note.content}">
                                    ${note.title}
                                </a>
                            `).join('');
                            
                            notesLoaded = true;
                        } catch (error) {
                            console.error('加载笔记列表失败:', error);
                            showToast('加载笔记列表失败', 'error');
                        }
                    }
                });

                nav.appendChild(notesLi);

                const divider = document.createElement('div');
                divider.className = 'category-nav-divider';
                divider.style.display = isNotesView ? 'block' : 'none';  // 根据当前视图设置分隔线的显示状态
                nav.appendChild(divider);

                // 添加"全部分类"选项
                const allCategoriesLi = document.createElement('li');
                allCategoriesLi.className = 'category-nav-item';
                allCategoriesLi.innerHTML = `
                    <div class="category-nav-header active">
                        <span>全部分类</span>
                    </div>
                `;

                const allCategoriesHeader = allCategoriesLi.querySelector('.category-nav-header');

                allCategoriesHeader.addEventListener('click', async () => {
                    // 移除所有分类的active类，包括"全部分类"
                    nav.querySelectorAll('.category-nav-header').forEach(h => {
                        h.classList.remove('active');
                    });
                    allCategoriesHeader.classList.add('active');

                    // 更新分类筛选器的选中状态
                    const filterSelect = document.querySelector('.category-filter .selected-option');
                    const filterItems = document.querySelectorAll('.category-filter .dropdown-item');
                    
                    // 更新筛选器的显示文本和值
                    filterSelect.textContent = '显示所有分类';
                    filterSelect.setAttribute('data-value', 'all');
                    
                    // 更新筛选器选项的选中状态
                    filterItems.forEach(item => {
                        item.classList.remove('selected');
                        if (item.getAttribute('data-value') === 'all') {
                            item.classList.add('selected');
                        }
                    });

                    if (currentExpandedCategory) {
                        const element = categoryElements.get(currentExpandedCategory);
                        if (element) {
                            element.toggle.classList.remove('expanded');
                            element.links.classList.remove('expanded');
                        }
                        currentExpandedCategory = null;
                    }

                    await filterLinksByCategory('all');
                    scrollToTop();
                });

                nav.appendChild(allCategoriesLi);

                const response = await fetch(`${baseUrl}/api/categories?sort=${isCategoryDescSort ? 'desc' : 'asc'}`);
                if (!response.ok) throw new Error('获取分类失败');
                const categories = await response.json();

                for (const category of categories) {
                    const li = document.createElement('li');
                    li.className = 'category-nav-item';
                    li.innerHTML = `
                        <div class="category-nav-header">
                            <span class="category-nav-toggle">▶</span>
                            <span class="category-name">${category}</span>
                        </div>
                        <div class="category-nav-links"></div>
                    `;

                    const header = li.querySelector('.category-nav-header');
                    const toggle = li.querySelector('.category-nav-toggle');
                    const links = li.querySelector('.category-nav-links');
                    let linksLoaded = false;

                    categoryElements.set(category, { header, toggle, links, li });

                    header.addEventListener('click', async () => {
                        // 移除所有分类的active类，包括"全部分类"
                        nav.querySelectorAll('.category-nav-header').forEach(h => {
                            h.classList.remove('active');
                        });
                        header.classList.add('active');

                        // 更新分类筛选器的选中状态
                        const categoryName = header.querySelector('.category-name').textContent;
                        const filterSelect = document.querySelector('.category-filter .selected-option');
                        const filterItems = document.querySelectorAll('.category-filter .dropdown-item');
                        
                        // 更新筛选器的显示文本和值
                        filterSelect.textContent = categoryName;
                        filterSelect.setAttribute('data-value', categoryName);
                        
                        // 更新筛选器选项的选中状态
                        filterItems.forEach(item => {
                            item.classList.remove('selected');
                            if (item.getAttribute('data-value') === categoryName) {
                                item.classList.add('selected');
                            }
                        });

                        if (currentExpandedCategory === category) {
                            toggle.classList.remove('expanded');
                            links.classList.remove('expanded');
                            currentExpandedCategory = null;
                            
                            await loadLinks(category);
                            scrollToTop();
                            return;
                        }

                        if (currentExpandedCategory) {
                            const prevElement = categoryElements.get(currentExpandedCategory);
                            if (prevElement) {
                                prevElement.toggle.classList.remove('expanded');
                                prevElement.links.classList.remove('expanded');
                            }
                        }

                        toggle.classList.add('expanded');
                        links.classList.add('expanded');
                        currentExpandedCategory = category;

                        if (!linksLoaded) {
                            try {
                                const linksResponse = await fetch(`${baseUrl}/api/links/${encodeURIComponent(category)}`);
                                if (!linksResponse.ok) throw new Error('获取链接失败');
                                
                                const categoryLinks = await linksResponse.json();
                                links.innerHTML = categoryLinks.map(link => `
                                    <a href="${link.url}" class="category-nav-link" target="_blank" title="${link.description || ''}">
                                        ${link.title}
                                    </a>
                                `).join('');
                                
                                linksLoaded = true;
                            } catch (error) {
                                console.error('加载分类链接失败:', error);
                                showToast('加载分类链接失败', 'error');
                            }
                        }

                        await loadLinks(category);
                        scrollToTop();
                    });

                    nav.appendChild(li);
                }
            } catch (error) {
                console.error('加载分类导航失败:', error);
                showToast('加载分类导航失败: ' + error.message, 'error');
            }
        }

        // 添加确认对话框相关函数
        let confirmCallback = null;

        function showConfirmDialog(message, callback) {
            const dialog = document.getElementById('confirmDialog');
            const content = dialog.querySelector('.confirm-dialog-content');
            content.textContent = message;
            dialog.style.display = 'flex';
            confirmCallback = callback;
        }

        function closeConfirmDialog() {
            const dialog = document.getElementById('confirmDialog');
            dialog.style.display = 'none';
            confirmCallback = null;
        }

        function handleConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmDialog();
        }

        // 添加自定义下拉框相关函数
        function toggleDropdown(event) {
            console.log('toggleDropdown 被触发', event.currentTarget);
            const select = event.currentTarget;
            select.classList.toggle('open');
            
            // 点击外部关闭下拉框
            if (select.classList.contains('open')) {
                console.log('下拉框被打开');
                document.addEventListener('click', function closeDropdown(e) {
                    console.log('点击事件触发，检查是否需要关闭下拉框', e.target);
                    if (!select.contains(e.target)) {
                        select.classList.remove('open');
                        document.removeEventListener('click', closeDropdown);
                        console.log('下拉框被关闭');
                    }
                });
            }
        }

        // 处理分类项点击
        function handleCategoryItemClick(event) {
            console.log('handleCategoryItemClick 被触发');
            console.log('点击的目标元素:', event.target);
            
            event.stopPropagation(); // 阻止事件冒泡
            const item = event.target.closest('.dropdown-item');
            console.log('找到的 dropdown-item:', item);
            
            if (!item) {
                console.log('未找到有效的 dropdown-item');
                return;
            }
            
            const value = item.getAttribute('data-value');
            const text = item.textContent.trim();
            console.log('选中的值:', value);
            console.log('选中的文本:', text);
            
            // 更新选中状态
            const customSelect = item.closest('.custom-select');
            console.log('找到的 custom-select:', customSelect);
            
            const dropdownItems = customSelect.querySelectorAll('.dropdown-item');
            dropdownItems.forEach(di => di.classList.remove('selected'));
            item.classList.add('selected');
            
            // 更新显示文本
            const selectedOption = customSelect.querySelector('.selected-option');
            console.log('找到的 selected-option:', selectedOption);
            selectedOption.textContent = text;
            selectedOption.setAttribute('data-value', value);
            
            // 关闭下拉框
            customSelect.classList.remove('open');
            
            // 只有在分类过滤器中才触发过滤
            if (customSelect.closest('.category-filter')) {
                console.log('触发分类过滤');
                handleCategoryFilterChange(value);
            } else if (customSelect.closest('.link-form')) {
                console.log('添加链接表单选择分类:', value);
                // 同步更新分类过滤器的选择
                const filterSelect = document.querySelector('.category-filter .selected-option');
                if (filterSelect) {
                    filterSelect.textContent = text;
                    filterSelect.setAttribute('data-value', value);
                    handleCategoryFilterChange(value);
                }
            }
        }

        // 为所有dropdown-item添加点击事件
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - 开始设置事件监听');
            
            // 为所有的dropdown-menu添加点击事件委托
            const dropdownMenus = document.querySelectorAll('.dropdown-menu');
            dropdownMenus.forEach(menu => {
                console.log('为下拉菜单添加点击事件:', menu);
                menu.addEventListener('click', function(event) {
                    console.log('dropdown-menu click 事件触发');
                    const item = event.target.closest('.dropdown-item');
                    if (!item) {
                        console.log('点击的不是下拉选项');
                        return;
                    }
                    handleCategoryItemClick(event);
                });
            });
            
            console.log('事件监听器设置完成');
        });

        // 导出模板
        function exportTemplate() {
            // 显示说明对话框
            const instructionDialog = document.createElement('div');
            instructionDialog.className = 'confirm-dialog-overlay';
            instructionDialog.style.display = 'flex';
            instructionDialog.innerHTML = `
                <div class="confirm-dialog">
                    <div class="confirm-dialog-title">导入文件格式说明</div>
                    <div class="confirm-dialog-content">
                        <p style="margin-bottom: 15px;">JSON文件格式要求：</p>
                        <ol style="list-style-type: decimal; padding-left: 20px;">
                            <li style="margin-bottom: 10px;">文件必须是一个数组，包含多个链接对象</li>
                            <li style="margin-bottom: 10px;">每个链接对象必须包含以下字段：
                                <ul style="list-style-type: disc; padding-left: 20px; margin-top: 5px;">
                                    <li>category: 分类名称</li>
                                    <li>title: 网站名称</li>
                                    <li>url: 网站地址（支持 http:// 或 https:// 开头）</li>
                                    <li>description: 网站描述（可选字段）</li>
                                </ul>
                            </li>
                        </ol>
                        <p style="margin-top: 15px;">点击确定下载示例文件</p>
                    </div>
                    <div class="confirm-dialog-buttons">
                        <button class="confirm-dialog-button confirm-dialog-cancel" onclick="this.closest('.confirm-dialog-overlay').remove()">取消</button>
                        <button class="confirm-dialog-button confirm-dialog-confirm" onclick="downloadTemplate(this)">确定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(instructionDialog);
        }

        // 下载模板文件
        function downloadTemplate(button) {
            const template = [
                {
                    "category": "示例分类",
                    "title": "示例网站名称",
                    "url": "https://example.com",
                    "description": "这是一个示例描述（可选）"
                },
                {
                    "category": "示例分类2",
                    "title": "示例网站2",
                    "url": "https://example2.com",
                    "description": "这是另一个示例描述"
                }
            ];

            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'links_template.json';
            a.click();
            URL.revokeObjectURL(url);
            button.closest('.confirm-dialog-overlay').remove();
            showToast('示例文件下载成功！');
        }

        // 笔记管理
        const noteManager = {
            isSubmitting: false,

            async addNote() {
                if (this.isSubmitting) {
                    utils.showToast('请等待当前操作完成', 'info');
                    return;
                }

                const title = document.getElementById('noteTitle').value;
                const content = document.getElementById('noteContent').value;
                const tags = document.getElementById('noteTags').value;

                if (!title || !content) {
                    utils.showToast('标题和内容为必填项', 'error');
                    return;
                }

                this.isSubmitting = true;
                utils.showToast('正在添加笔记...', 'info');

                try {
                    const response = await fetch(`${baseUrl}/api/notes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title, content, tags })
                    });

                    if (!response.ok) {
                        throw new Error('添加笔记失败');
                    }

                    // 清空表单
                    this.clearNoteForm();
                    
                    // 重新加载笔记列表
                    await this.loadNotes();
                    
                    // 更新左侧导航栏的笔记列表
                    const notesLinks = document.querySelector('.category-nav-item .category-nav-links');
                    if (notesLinks) {
                        const response = await fetch(`${baseUrl}/api/notes`);
                        if (!response.ok) throw new Error('获取笔记列表失败');
                        
                        const notes = await response.json();
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        notesLinks.innerHTML = notes.map(note => `
                            <a href="#" class="category-nav-link" onclick="showNoteDetail(${note.id}); return false;" title="${escapeHtml(note.content)}">
                                ${escapeHtml(note.title)}
                            </a>
                        `).join('');
                    }

                    utils.showToast('笔记添加成功！', 'success');
                } catch (error) {
                    console.error('添加笔记失败:', error);
                    utils.showToast('添加笔记失败', 'error');
                } finally {
                    this.isSubmitting = false;
                }
            },

            async loadNotes() {
                try {
                    const response = await fetch(`${baseUrl}/api/notes?sort=${isNoteDescSort ? 'desc' : 'asc'}`);
                    if (!response.ok) {
                        throw new Error('获取笔记失败');
                    }

                    const notes = await response.json();
                    this.renderNotes(notes);

                    // 初始化拖拽排序
                    const notesList = document.getElementById('notesList');
                    if (notesList) {
                        new Sortable(notesList, {
                            animation: 150,
                            ghostClass: 'note-card-ghost',
                            onEnd: async function(evt) {
                                const noteIds = Array.from(notesList.children).map(
                                    card => card.getAttribute('data-note-id')
                                );
                                
                                try {
                                    const response = await fetch(`${baseUrl}/api/notes/reorder`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ noteIds })
                                    });
                                    
                                    if (!response.ok) {
                                        throw new Error('更新笔记顺序失败');
                                    }
                                    
                                    showToast('笔记顺序更新成功');
                                } catch (error) {
                                    console.error('更新笔记顺序失败:', error);
                                    showToast('更新笔记顺序失败', 'error');
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('加载笔记失败:', error);
                    utils.showToast('加载笔记失败', 'error');
                }
            },

            async deleteNote(id) {
                // 显示自定义确认对话框
                const confirmDialog = document.getElementById('confirmDialog');
                const confirmContent = confirmDialog.querySelector('.confirm-dialog-content');
                confirmContent.textContent = '确定要删除这个笔记吗？';
                confirmDialog.style.display = 'flex';

                // 设置确认按钮的点击事件
                const confirmBtn = confirmDialog.querySelector('.confirm-dialog-confirm');
                const originalOnClick = confirmBtn.onclick;
                confirmBtn.onclick = async () => {
                    // 立即关闭对话框
                    confirmDialog.style.display = 'none';
                    
                    try {
                        const response = await fetch(`${baseUrl}/api/notes/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error('删除笔记失败');
                        }

                        utils.showToast('笔记删除成功', 'success');
                        
                        // 重新加载笔记列表
                        await this.loadNotes();
                        
                        // 更新左侧导航栏的笔记列表
                        const notesLinks = document.querySelector('.category-nav-item .category-nav-links');
                        if (notesLinks) {
                            const response = await fetch(`${baseUrl}/api/notes`);
                            if (!response.ok) throw new Error('获取笔记列表失败');
                            
                            const notes = await response.json();
                            const escapeHtml = (text) => {
                                const div = document.createElement('div');
                                div.textContent = text;
                                return div.innerHTML;
                            };
                            
                            notesLinks.innerHTML = notes.map(note => `
                                <a href="#" class="category-nav-link" onclick="showNoteDetail(${note.id}); return false;" title="${escapeHtml(note.content)}">
                                    ${escapeHtml(note.title)}
                                </a>
                            `).join('');
                        }
                    } catch (error) {
                        console.error('删除笔记失败:', error);
                        utils.showToast('删除笔记失败', 'error');
                    } finally {
                        // 恢复确认按钮的原始事件处理程序
                        confirmBtn.onclick = originalOnClick;
                    }
                };

                // 设置取消按钮的点击事件
                const cancelBtn = confirmDialog.querySelector('.confirm-dialog-cancel');
                cancelBtn.onclick = () => {
                    // 恢复确认按钮的原始事件处理程序
                    confirmBtn.onclick = originalOnClick;
                    // 关闭对话框
                    confirmDialog.style.display = 'none';
                };
            },

            async editNote(id) {
                try {
                    const response = await fetch(`${baseUrl}/api/notes/${id}`);
                    if (!response.ok) {
                        throw new Error('获取笔记失败');
                    }

                    const note = await response.json();
                    document.getElementById('noteTitle').value = note.title;
                    document.getElementById('noteContent').value = note.content;
                    document.getElementById('noteTags').value = note.tags || '';

                    // 将表单滚动到可见位置
                    document.querySelector('.note-form').scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('加载笔记失败:', error);
                    utils.showToast('加载笔记失败', 'error');
                }
            },

            renderNotes(notes) {
                const notesList = document.getElementById('notesList');
                notesList.innerHTML = notes.map(note => {
                    // HTML转义函数
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };

                    // JavaScript字符串转义函数
                    const escapeJsString = (text) => {
                        if (!text) return '';
                        // 先将文本转换为Base64编码，避免所有特殊字符问题
                        return btoa(unescape(encodeURIComponent(text)));
                    };
                    
                    // 根据内容长度判断类名
                    const contentLength = note.content.length;
                    const cardClass = contentLength > 200 ? 'note-card long-content' : 'note-card short-content';
                    
                    // 预处理所有需要转义的内容
                    const escapedTitle = escapeJsString(note.title || '');
                    const escapedContent = escapeJsString(note.content || '');
                    const escapedTags = escapeJsString(note.tags || '');
                    
                    return `
                    <div class="${cardClass}" data-note-id="${note.id}">
                        <h3>${escapeHtml(note.title)}</h3>
                        <div class="note-content">${escapeHtml(note.content)}</div>
                        ${note.tags ? `<div class="note-tags">标签: ${escapeHtml(note.tags)}</div>` : ''}
                        <div class="note-actions">
                            <button class="edit-note" onclick="editNoteDialog(${note.id}, '${escapedTitle}', '${escapedContent}', '${escapedTags}')">编辑</button>
                            <button class="delete-note" onclick="noteManager.deleteNote(${note.id})">删除</button>
                        </div>
                    </div>
                    `;
                }).join('');
            },

            clearNoteForm() {
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                document.getElementById('noteTags').value = '';
            }
        };

        // 显示笔记视图
        async function showNotes() {
            // 显示笔记相关内容
            document.getElementById('notesContainer').style.display = 'block';
            document.getElementById('noteTools').style.display = 'block';
            
            // 隐藏链接相关内容
            document.getElementById('linksContainer').style.display = 'none';
            document.getElementById('linkTools').style.display = 'none';
            
            // 更新导航栏状态
            document.querySelector('.nav-links a.active').classList.remove('active');
            document.querySelector('.nav-links a:last-child').classList.add('active');

            try {
                // 获取所有笔记
                const response = await fetch(`${baseUrl}/api/notes`);
                if (!response.ok) throw new Error('获取笔记失败');
                const notes = await response.json();

                // 更新侧边栏导航
                const categoryNav = document.getElementById('categoryNav');
                let navHtml = `
                    <li class="category-nav-item">
                        <div class="category-nav-header active" onclick="handleCategoryClick(event, 'notes')">
                            <span class="category-name">我的笔记</span>
                        </div>
                        <div class="category-nav-links expanded">
                `;

                // 添加笔记标题到导航
                notes.forEach(note => {
                    navHtml += `
                        <a href="#note-${note.id}" class="category-nav-link" onclick="scrollToNote(${note.id})">
                            ${note.title}
                        </a>
                    `;
                });

                navHtml += `
                        </div>
                    </li>
                `;

                categoryNav.innerHTML = navHtml;
            } catch (error) {
                console.error('加载笔记导航失败:', error);
                showToast('加载笔记导航失败: ' + error.message, 'error');
            }
            
            // 加载笔记列表
            loadNotes();
        }

        async function showLinks() {
            // 显示链接相关内容
            document.getElementById('linksContainer').style.display = 'block';
            document.getElementById('linkTools').style.display = 'block';
            
            // 隐藏笔记相关内容
            document.getElementById('notesContainer').style.display = 'none';
            document.getElementById('noteTools').style.display = 'none';
            
            // 更新导航栏状态
            document.querySelector('.nav-links a.active').classList.remove('active');
            document.querySelector('.nav-links a:first-child').classList.add('active');

            // 重新初始化导航栏
            await updateSidebarNav();
            
            // 加载所有链接
            await filterLinksByCategory('all');
        }

        // 添加笔记滚动函数
        function scrollToNote(noteId) {
            const noteElement = document.getElementById(`note-${noteId}`);
            if (noteElement) {
                noteElement.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // 修改笔记搜索功能
        function searchNotes() {
            const searchText = document.getElementById('noteSearchInput').value.toLowerCase();
            const searchType = document.querySelector('input[name="search-type"]:checked').value;
            
            // 根据搜索类型更新placeholder
            const searchInput = document.getElementById('noteSearchInput');
            searchInput.placeholder = searchType === 'content' ? '搜索笔记内容...' : '搜索标签，多个标签用逗号分隔...';
            
            noteManager.searchNotes(searchText, searchType);
        }

        // 扩展笔记管理器功能
        Object.assign(noteManager, {
            async searchNotes(searchText, searchType = 'content') {
                try {
                    const response = await fetch(`${baseUrl}/api/notes/search?q=${encodeURIComponent(searchText)}&type=${searchType}`);
                    if (!response.ok) {
                        throw new Error('搜索笔记失败');
                    }
                    const notes = await response.json();
                    
                    // 如果是标签搜索，对结果进行标签高亮处理
                    if (searchType === 'tag' && searchText) {
                        const searchTags = searchText.split(',').map(tag => tag.trim().toLowerCase());
                        notes.forEach(note => {
                            if (note.tags) {
                                const noteTags = note.tags.split(',').map(tag => tag.trim());
                                note.tags = noteTags.map(tag => {
                                    if (searchTags.includes(tag.toLowerCase())) {
                                        return `<span class="highlighted-tag">${tag}</span>`;
                                    }
                                    return tag;
                                }).join(', ');
                            }
                        });
                    }
                    
                    this.renderNotes(notes);
                    
                    // 显示搜索结果统计
                    const resultCount = notes.length;
                    utils.showToast(`找到 ${resultCount} 个${searchType === 'tag' ? '标签匹配的' : ''}笔记`);
                } catch (error) {
                    console.error('搜索笔记失败:', error);
                    utils.showToast('搜索笔记失败', 'error');
                }
            },

            async exportNotes() {
                try {
                    const response = await fetch(`${baseUrl}/api/notes/export`);
                    if (!response.ok) {
                        throw new Error('导出笔记失败');
                    }
                    const notes = await response.json();
                    const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'notes.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    utils.showToast('笔记导出成功');
                } catch (error) {
                    console.error('导出笔记失败:', error);
                    utils.showToast('导出笔记失败', 'error');
                }
            },

            async importNotes() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const notes = JSON.parse(event.target.result);
                            const response = await fetch(`${baseUrl}/api/notes/import`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ notes })
                            });

                            if (!response.ok) {
                                throw new Error('导入笔记失败');
                            }

                            await this.loadNotes();
                            utils.showToast('笔记导入成功');
                        };
                        reader.readAsText(file);
                    } catch (error) {
                        console.error('导入笔记失败:', error);
                        utils.showToast('导入笔记失败', 'error');
                    }
                };
                input.click();
            }
        });

        // HTML转义函数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 添加笔记编辑对话框函数
        function editNoteDialog(id, title, content, tags) {
            const overlay = document.createElement('div');
            overlay.className = 'edit-dialog-overlay';
            
            // 解码Base64并还原文本
            const decodeBase64 = (base64) => {
                if (!base64) return '';
                try {
                    return decodeURIComponent(escape(atob(base64)));
                } catch (e) {
                    console.error('解码失败:', e);
                    return '';
                }
            };
            
            const decodedTitle = decodeBase64(title);
            const decodedContent = decodeBase64(content);
            const decodedTags = decodeBase64(tags);
            
            overlay.innerHTML = `
                <div class="edit-dialog">
                    <div class="edit-dialog-title">编辑笔记</div>
                    <div class="edit-form-group">
                        <label for="editNoteTitle">笔记标题</label>
                        <input type="text" id="editNoteTitle" value="${escapeHtml(decodedTitle)}">
                    </div>
                    <div class="edit-form-group">
                        <label for="editNoteContent">笔记内容</label>
                        <textarea id="editNoteContent" style="min-height: 150px; width: 100%;">${escapeHtml(decodedContent)}</textarea>
                    </div>
                    <div class="edit-form-group">
                        <label for="editNoteTags">标签</label>
                        <input type="text" id="editNoteTags" value="${escapeHtml(decodedTags)}" placeholder="用逗号分隔多个标签">
                    </div>
                    <div class="edit-dialog-buttons">
                        <button class="edit-dialog-button edit-dialog-cancel" onclick="this.closest('.edit-dialog-overlay').remove()">取消</button>
                        <button class="edit-dialog-button edit-dialog-confirm" onclick="updateNote(${id})">保存</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        // 添加更新笔记函数
        async function updateNote(id) {
            const title = document.getElementById('editNoteTitle').value.trim();
            const content = document.getElementById('editNoteContent').value.trim();
            const tags = document.getElementById('editNoteTags').value.trim();

            if (!title || !content) {
                showToast('标题和内容不能为空', 'error');
                return;
            }

            try {
                const response = await fetch(`${baseUrl}/api/notes/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content, tags })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '更新失败');
                }

                // 关闭编辑对话框
                document.querySelector('.edit-dialog-overlay').remove();

                // 重新加载笔记列表
                await noteManager.loadNotes();
                
                // 更新左侧导航栏的笔记列表
                const notesLinks = document.querySelector('.category-nav-item .category-nav-links');
                if (notesLinks) {
                    const response = await fetch(`${baseUrl}/api/notes`);
                    if (!response.ok) throw new Error('获取笔记列表失败');
                    
                    const notes = await response.json();
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        return text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#039;');
                    };
                    
                    notesLinks.innerHTML = notes.map(note => `
                        <a href="#" class="category-nav-link" onclick="showNoteDetail(${note.id}); return false;" title="${escapeHtml(note.content)}">
                            ${escapeHtml(note.title)}
                        </a>
                    `).join('');
                }

                showToast('笔记更新成功！');
            } catch (error) {
                console.error('更新笔记失败:', error);
                showToast('更新笔记失败: ' + error.message, 'error');
            }
        }

        // 添加笔记详情显示函数
        async function showNoteDetail(noteId) {
            try {
                const response = await fetch(`${baseUrl}/api/notes/${noteId}`);
                if (!response.ok) throw new Error('获取笔记详情失败');
                
                const note = await response.json();
                
                // 切换到笔记视图
                showNotes();
                
                // 滚动到对应的笔记卡片
                const noteCard = document.querySelector(`[data-note-id="${noteId}"]`);
                if (noteCard) {
                    noteCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // 添加高亮效果
                    noteCard.style.animation = 'highlight 2s';
                }
            } catch (error) {
                console.error('获取笔记详情失败:', error);
                showToast('获取笔记详情失败', 'error');
            }
        }

        // 过滤指定分类的链接
        async function filterLinksByCategory(category) {
            try {
                console.log(`开始过滤分类: ${category}`);
                console.log('当前排序状态:', isCategoryDescSort ? '降序' : '升序');

                // 先获取当前所有分类
                const categoriesResponse = await fetch(`${baseUrl}/api/categories?sort=${isCategoryDescSort ? 'desc' : 'asc'}`);
                if (!categoriesResponse.ok) {
                    throw new Error('获取分类失败');
                }
                const categories = await categoriesResponse.json();
                console.log('当前所有分类:', categories);

                // 使用原有的API路径格式
                const response = await fetch(`${baseUrl}/api/links/${encodeURIComponent(category)}`);
                if (!response.ok) {
                    throw new Error('获取链接失败');
                }
                
                const links = await response.json();
                console.log(`获取到 ${links.length} 个链接`);
                console.log('链接数据:', links);
                
                const linksContainer = document.querySelector('.links-container');
                
                if (links.length === 0 || (category !== 'all' && !categories.includes(category))) {
                    console.log('没有找到链接或分类已被删除，显示空状态');
                    console.log('条件判断:', {
                        linksLength: links.length,
                        category,
                        categoryExists: categories.includes(category)
                    });
                    const message = category === 'all' 
                        ? '<div class="empty-message">暂无任何链接，请点击右侧"添加新链接"开始添加</div>'
                        : categories.includes(category)
                            ? `<div class="empty-message">分类"${category}"下暂无链接，请先添加链接</div>`
                            : '<div class="empty-message">该分类已被删除</div>';
                    linksContainer.innerHTML = message;
                    return;
                }
                
                // 过滤掉已删除分类的链接
                const validLinks = links.filter(link => {
                    const isValid = categories.includes(link.category);
                    console.log(`链接 "${link.title}" 的分类 "${link.category}" ${isValid ? '有效' : '无效'}`);
                    return isValid;
                });
                console.log('过滤后的有效链接数量:', validLinks.length);
                
                // 按分类分组链接
                const groupedLinks = {};
                validLinks.forEach(link => {
                    if (!groupedLinks[link.category]) {
                        groupedLinks[link.category] = [];
                    }
                    groupedLinks[link.category].push(link);
                });
                
                console.log('分组后的分类数量:', Object.keys(groupedLinks).length);
                console.log('分组结果:', groupedLinks);

                // 对分类进行排序
                const sortedCategories = Object.keys(groupedLinks).sort((a, b) => {
                    return isCategoryDescSort ? b.localeCompare(a) : a.localeCompare(b);
                });
                console.log('排序后的分类顺序:', sortedCategories);
                
                // 生成HTML
                let html = '';
                for (const category of sortedCategories) {
                    const categoryLinks = groupedLinks[category];
                    html += `
                        <div class="category-section" data-category="${category}">
                            <div class="category-title">
                                <span>${category}</span>
                                <div class="category-actions">
                                    <button class="category-edit-button" onclick="editCategory('${category}')">编辑</button>
                                    <button class="category-delete-button" onclick="deleteCategory('${category}')">删除</button>
                                </div>
                            </div>
                            <div class="links-list">
                                ${categoryLinks.map(link => `
                                    <div class="link-item">
                                        <div class="link-content">
                                            <img src="${link.favicon || defaultFaviconUrl}" alt="favicon" class="link-favicon" onerror="this.src='${defaultFaviconUrl}'">
                                            <div class="link-info">
                                                <a href="${link.url}" class="link-title" target="_blank" onclick="recordVisit('${link.id}')">${link.title}</a>
                                                ${link.description ? `<div class="link-description">${link.description}</div>` : ''}
                                            </div>
                                        </div>
                                        <div class="link-actions">
                                            <button class="edit-button" onclick="editLink('${link.id}', '${link.title.replace(/'/g, "\\'")}', '${link.url.replace(/'/g, "\\'")}', '${(link.description || '').replace(/'/g, "\\'")}')">编辑</button>
                                            <button class="delete-button" onclick="deleteLink('${link.id}')">删除</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                console.log('更新链接容器内容');
                linksContainer.innerHTML = html;
                
                // 初始化分类的拖拽排序
                const categoriesContainer = document.querySelector('.links-container');
                if (categoriesContainer) {
                    console.log('初始化分类拖拽排序');
                    new Sortable(categoriesContainer, {
                        animation: 150,
                        handle: '.category-title',
                        ghostClass: 'category-ghost',
                        onEnd: async function(evt) {
                            const categories = Array.from(categoriesContainer.children).map(
                                section => section.getAttribute('data-category')
                            );
                            
                            try {
                                const response = await fetch(`${baseUrl}/api/categories/reorder`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ categories })
                                });
                                
                                if (!response.ok) {
                                    throw new Error('更新分类顺序失败');
                                }
                                
                                showToast('分类顺序更新成功');
                            } catch (error) {
                                console.error('更新分类顺序失败:', error);
                                showToast('更新分类顺序失败', 'error');
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('过滤链接失败:', error);
                showToast('过滤链接失败: ' + error.message, 'error');
            }
        }

        // 上传图标并更新favicon
        async function uploadIconAndUpdateFavicon(linkId, iconFile) {
            try {
                // 创建FormData对象
                const formData = new FormData();
                formData.append('icon', iconFile);

                // 上传图标
                const uploadResponse = await fetch(`${baseUrl}/api/upload-icon`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('上传图标失败');
                }

                const { iconUrl } = await uploadResponse.json();

                // 更新链接的favicon
                const updateResponse = await fetch(`${baseUrl}/api/links/${linkId}/favicon`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ favicon: iconUrl })
                });

                if (!updateResponse.ok) {
                    throw new Error('更新favicon失败');
                }

                // 重新加载链接列表
                await loadLinks('all');
                showToast('图标更新成功！');
            } catch (error) {
                console.error('更新图标失败:', error);
                showToast('更新图标失败: ' + error.message, 'error');
            }
        }

        // 自动更新华为引擎说明的favicon
        async function autoUpdateHuaweiFavicon() {
            try {
                const response = await fetch(`${baseUrl}/api/auto-update-huawei-favicon`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('自动更新华为图标失败');
                }

                const result = await response.json();
                await loadLinks('all');
                showToast('华为引擎说明favicon更新成功！');
            } catch (error) {
                console.error('自动更新华为图标失败:', error);
                showToast('自动更新华为图标失败: ' + error.message, 'error');
            }
        }

        // 在显示链接的HTML中，修改img标签的src属性处理
        function createLinkCard(link) {
            // 处理favicon URL
            console.log('[createLinkCard] 开始处理链接:', link.title);
            console.log('[createLinkCard] 原始favicon:', link.favicon);
            
            let faviconUrl = defaultFaviconUrl;
            if (link.favicon) {
                if (link.favicon.startsWith('http')) {
                    faviconUrl = link.favicon;
                    console.log('[createLinkCard] 使用完整URL:', faviconUrl);
                } else {
                    // 如果是相对路径，添加baseUrl
                    faviconUrl = baseUrl + link.favicon;
                    console.log('[createLinkCard] 添加baseUrl后:', faviconUrl);
                }
            } else {
                console.log('[createLinkCard] 使用默认favicon');
            }
            
            return `
                <div class="link-card" data-id="${link.id}">
                    <div class="link-content">
                        <img src="${faviconUrl}" alt="favicon" class="link-favicon" onerror="this.src='${defaultFaviconUrl}'">
                        <div class="link-info">
                            <a href="${link.url}" class="link-title" target="_blank" onclick="recordVisit('${link.id}')">${link.title}</a>
                            ${link.description ? `<div class="link-description">${link.description}</div>` : ''}
                        </div>
                    </div>
                    <div class="link-actions">
                        <button class="edit-button" onclick="editLink('${link.id}', '${link.title.replace(/'/g, "\\'")}', '${link.url.replace(/'/g, "\\'")}', '${(link.description || '').replace(/'/g, "\\'")}')">编辑</button>
                        <button class="delete-button" onclick="deleteLink('${link.id}')">删除</button>
                    </div>
                </div>
            `;
        }

        // 更新链接的favicon
        async function updateLinkFavicon(linkId) {
            try {
                console.log('[updateLinkFavicon] 开始更新链接favicon, linkId:', linkId);
                const response = await fetch(`${baseUrl}/api/auto-update-favicon/${linkId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('更新favicon失败');
                }

                const data = await response.json();
                console.log('[updateLinkFavicon] 更新成功，新的favicon:', data.iconUrl);
                return data.iconUrl;
            } catch (error) {
                console.error('[updateLinkFavicon] 更新失败:', error);
                return null;
            }
        }

        function displayLinks(links) {
            const linkContainer = document.getElementById('linkContainer');
            linkContainer.innerHTML = '';
            
            // 按分类分组
            const groupedLinks = {};
            links.forEach(link => {
                if (!groupedLinks[link.category]) {
                    groupedLinks[link.category] = [];
                }
                groupedLinks[link.category].push(link);
            });
            
            // 获取排序后的分类
            const sortedCategories = Object.keys(groupedLinks).sort((a, b) => {
                const categoryOrder = categories.indexOf(a) - categories.indexOf(b);
                return sortDirection === 'desc' ? -categoryOrder : categoryOrder;
            });
            
            console.log('排序后的分类顺序:', sortedCategories);
            
            // 按分类显示链接
            sortedCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-section';
                categoryDiv.setAttribute('data-category', category);
                
                const categoryHeader = document.createElement('h2');
                categoryHeader.textContent = category;
                categoryDiv.appendChild(categoryHeader);
                
                const linksDiv = document.createElement('div');
                linksDiv.className = 'links-container';
                
                groupedLinks[category].forEach(link => {
                    const linkCard = document.createElement('div');
                    linkCard.className = 'link-card';
                    linkCard.setAttribute('data-id', link.id);
                    
                    // 使用getFaviconUrl处理图标URL
                    const faviconUrl = getFaviconUrl(link.favicon);
                    console.log('处理后的favicon URL:', faviconUrl); // 添加日志
                    
                    linkCard.innerHTML = `
                        <div class="link-content">
                            <img src="${faviconUrl}" alt="favicon" class="link-favicon" onerror="this.src='${defaultFaviconUrl}'">
                            <div class="link-info">
                                <a href="${link.url}" class="link-title" target="_blank" onclick="recordVisit('${link.id}')">${link.title}</a>
                                ${link.description ? `<div class="link-description">${link.description}</div>` : ''}
                            </div>
                        </div>
                        <div class="link-actions">
                            <button class="edit-button" onclick="editLink('${link.id}', '${link.title.replace(/'/g, "\\'")}', '${link.url.replace(/'/g, "\\'")}', '${(link.description || '').replace(/'/g, "\\'")}')">编辑</button>
                            <button class="delete-button" onclick="deleteLink('${link.id}')">删除</button>
                        </div>
                    `;
                    
                    linksDiv.appendChild(linkCard);
                });
                
                categoryDiv.appendChild(linksDiv);
                linkContainer.appendChild(categoryDiv);
            });
            
            // 初始化分类拖拽排序
            console.log('初始化分类拖拽排序');
            initializeCategorySort();
        }

        // 自动更新链接的favicon
        async function updateLinkFavicon(linkId) {
            try {
                const response = await fetch(`${baseUrl}/api/auto-update-favicon/${linkId}`, {
                    method: 'POST',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error('自动更新图标失败');
                }

                const result = await response.json();
                await loadLinks('all');
                showToast('网站图标更新成功！');
            } catch (error) {
                console.error('自动更新图标失败:', error);
                showToast('自动更新图标失败: ' + error.message, 'error');
            }
        }

        // 笔记排序方向
        let isNoteDescSort = true; // 默认降序排序

        // 切换笔记排序
        async function toggleNoteSort() {
            console.log('=== 开始切换笔记排序 ===');
            console.log('当前排序状态:', isNoteDescSort);
            
            // 切换排序状态
            isNoteDescSort = !isNoteDescSort;
            console.log('切换后的排序状态:', isNoteDescSort);
            
            // 更新排序按钮样式
            const sortButton = document.querySelector('.notes-section .sort-button');
            console.log('获取到排序按钮:', sortButton);
            
            const sortIcon = sortButton.querySelector('.sort-icon');
            console.log('获取到排序图标:', sortIcon);
            
            // 更新图标方向
            const newTransform = isNoteDescSort ? 'rotate(0deg)' : 'rotate(180deg)';
            console.log('设置新的transform:', newTransform);
            sortIcon.style.transform = newTransform;

            try {
                console.log('准备发送排序请求...');
                const url = `/api/notes?orderBy=created_at&sort=${isNoteDescSort ? 'desc' : 'asc'}`;
                console.log('请求URL:', url);
                
                const response = await fetch(url);
                console.log('获取到响应:', response.status);
                
                if (!response.ok) {
                    throw new Error('获取笔记失败');
                }
                
                const notes = await response.json();
                console.log('获取到笔记数据:', notes.length, '条');
                console.log('笔记数据示例:', notes[0]);
                
                // 更新笔记列表显示
                const notesList = document.getElementById('notesList');
                console.log('获取到笔记列表容器:', notesList);
                
                // 在更新HTML之前记录当前的笔记顺序
                console.log('更新前的笔记顺序:', notes.map(n => ({
                    id: n.id,
                    title: n.title,
                    created_at: n.created_at
                })));
                
                notesList.innerHTML = notes.map(note => `
                    <div class="note-item" data-id="${note.id}" data-time="${note.created_at}">
                        <h3>${note.title}</h3>
                        <p>${note.content}</p>
                        ${note.tags ? `<div class="tags">${note.tags.split(',').map(tag => `<span>${tag.trim()}</span>`).join('')}</div>` : ''}
                        <div class="note-time">${new Date(note.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
                
                console.log('笔记列表已更新');
                utils.showToast('排序更新成功');
            } catch (error) {
                console.error('更新笔记排序失败:', error);
                utils.showToast('更新排序失败', 'error');
            }
            console.log('=== 笔记排序切换完成 ===');
        }

        // 修改笔记管理器
        Object.assign(noteManager, {
            async loadNotes() {
                console.log('=== 开始加载笔记列表 ===');
                try {
                    const url = `/api/notes?orderBy=created_at&sort=${isNoteDescSort ? 'desc' : 'asc'}`;
                    console.log('加载笔记请求URL:', url);
                    
                    const response = await fetch(url);
                    console.log('加载笔记响应状态:', response.status);
                    
                    if (!response.ok) {
                        throw new Error('获取笔记失败');
                    }
                    
                    const notes = await response.json();
                    console.log('获取到笔记数据:', notes.length, '条');
                    
                    // 更新笔记列表显示
                    const notesList = document.getElementById('notesList');
                    console.log('获取到笔记列表容器:', notesList);
                    
                    notesList.innerHTML = notes.map(note => `
                        <div class="note-item" data-id="${note.id}" data-time="${note.created_at}">
                            <h3>${note.title}</h3>
                            <p>${note.content}</p>
                            ${note.tags ? `<div class="tags">${note.tags.split(',').map(tag => `<span>${tag.trim()}</span>`).join('')}</div>` : ''}
                            <div class="note-time">${new Date(note.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');
                    
                    console.log('笔记列表已更新');
                } catch (error) {
                    console.error('加载笔记失败:', error);
                }
                console.log('=== 笔记列表加载完成 ===');
            }
        });

        // 笔记列表容器
        const notesContainer = document.getElementById('notes-container');

        let isDragMode = false;
        let sortable = null;
        const dragSortBtn = document.getElementById('dragSortBtn');
        const notesList = document.getElementById('notesList');

        // 切换拖动排序模式
        dragSortBtn.addEventListener('click', () => {
            isDragMode = !isDragMode;
            dragSortBtn.textContent = isDragMode ? '完成排序' : '启用拖动排序';
            dragSortBtn.classList.toggle('active', isDragMode);

            const noteItems = document.querySelectorAll('.note-item');
            noteItems.forEach(item => {
                item.classList.toggle('draggable', isDragMode);
            });

            if (isDragMode) {
                // 启用拖拽排序
                sortable = new Sortable(notesList, {
                    animation: 150,
                    onEnd: async function(evt) {
                        const noteIds = Array.from(notesList.children)
                            .map(item => item.getAttribute('data-id'));
                        
                        try {
                            const response = await fetch('/api/notes/reorder', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ noteIds }),
                            });

                            if (!response.ok) {
                                throw new Error('排序更新失败');
                            }
                        } catch (error) {
                            console.error('更新笔记顺序失败:', error);
                            // 可以在这里添加错误提示
                        }
                    }
                });
            } else {
                // 禁用拖拽排序
                if (sortable) {
                    sortable.destroy();
                    sortable = null;
                }
            }
        });

        // 加载笔记列表
        async function loadNotes() {
            console.log('=== 开始加载笔记列表 ===');
            try {
                const url = `/api/notes?orderBy=created_at&sort=${isNoteDescSort ? 'desc' : 'asc'}`;
                console.log('加载笔记请求URL:', url);
                
                const response = await fetch(url);
                console.log('加载笔记响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error('获取笔记失败');
                }
                
                const notes = await response.json();
                console.log('获取到笔记数据:', notes.length, '条');
                
                // 更新笔记列表显示
                const notesList = document.getElementById('notesList');
                console.log('获取到笔记列表容器:', notesList);
                
                notesList.innerHTML = notes.map(note => `
                    <div class="note-item" data-id="${note.id}" data-time="${note.created_at}">
                        <h3>${note.title}</h3>
                        <p>${note.content}</p>
                        ${note.tags ? `<div class="tags">${note.tags.split(',').map(tag => `<span>${tag.trim()}</span>`).join('')}</div>` : ''}
                        <div class="note-time">${new Date(note.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
                
                console.log('笔记列表已更新');
            } catch (error) {
                console.error('加载笔记失败:', error);
            }
            console.log('=== 笔记列表加载完成 ===');
        }

        // 页面加载时获取笔记列表
        loadNotes();

        // 处理分类点击
        function handleCategoryClick(event, category) {
            event.preventDefault();
            
            // 如果点击的是笔记分类
            if (category === 'notes') {
                showNotes();
                return;
            }

            // 更新全局状态
            currentSelectedCategory = category;
            currentExpandedCategory = category === 'all' ? null : category;

            // 更新导航栏选中状态
            const headers = document.querySelectorAll('.category-nav-header');
            headers.forEach(header => header.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // 更新分类过滤器选中状态
            const dropdownItems = document.querySelectorAll('.dropdown-item');
            dropdownItems.forEach(item => item.classList.remove('selected'));
            const selectedItem = Array.from(dropdownItems).find(item => item.dataset.value === category);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            // 更新选中的选项显示
            const selectedOption = document.querySelector('.selected-option');
            selectedOption.textContent = category === 'all' ? '显示所有分类' : category;

            // 加载对应分类的链接
            loadLinks(category);
        }
    </script>
</body>
</html> 